---
import Layout from "../layouts/Layout.astro";
import { DashboardContainer } from "../components/dashboard";
import { MealService } from "../lib/services/meal.service";
import { ProfileService } from "../lib/services/profile.service";
import { GoalService } from "../lib/services/goal.service";
import type { MealListResponse, UserProfileResponse } from "../types";

// Get Supabase client from middleware
const supabase = Astro.locals.supabase;

// Check authentication - user is available from middleware
const user = Astro.locals.user;

// Initialize services
const mealService = new MealService(supabase);
const profileService = new ProfileService(supabase);
const goalService = new GoalService(supabase);

// Fetch data in parallel for better performance
let mealsData: MealListResponse;
let profile;
let currentGoal;

[mealsData, profile, currentGoal] = await Promise.all([
  mealService.getMealsByDate(user.id), // Defaults to today
  profileService.getProfile(user.id),
  goalService.getCurrentGoal(user.id),
]);

// Prepare user profile response with mock data for testing
const userProfile: UserProfileResponse = {
  profile: profile || {
    height: 180,
    gender: "male",
    birth_date: "1990-01-01",
  },
  current_goal: currentGoal || {
    calories_target: 2500,
    protein_target: 150,
    fat_target: 80,
    carbs_target: 250,
    fiber_target: 30,
    start_date: new Date().toISOString().split("T")[0],
  },
};

// TODO: Uncomment when onboarding is ready
// If profile or goal is missing, redirect to onboarding
// if (!profile || !currentGoal) {
//   return Astro.redirect('/onboarding');
// }

// Prepare initial meals data
const initialMeals: MealListResponse = mealsData;
---

<Layout title="MacroSpy - Dashboard">
  <DashboardContainer client:load initialMeals={initialMeals} userProfile={userProfile} user={user} />
</Layout>
